```{r echo=FALSE, message=FALSE, cache=TRUE}
rm(list=ls())
library(readr)
library(dplyr)
library(tidyr)
library(nlme)
library(lme4)
library(ggplot2)
library(Amelia)
library(arm)
set.seed(1)

setwd("H:/")

substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

### PULLED COL WIDTH, COL NAMES FROM VariableLayout.xlsx, transposed
### READ AND CLEAN DATA
state.mal<-read.csv("H:/data/strpt00-12.csv", stringsAsFactors = FALSE)
### remove XX (death cases) and PR - can add death cases back in with state file (probably should!)
state.mal<-state.mal[-which(state.mal$staterr%in%c("XX", "PR")),]

cnty.mal<-read.csv("H:/data/cntyrpt06-12.csv", stringsAsFactors = FALSE)
### Strip out missing and de-identified counties
cnty.mal<-cnty.mal[-which(cnty.mal$rptfips==0),]
cnty.mal<-cnty.mal[which(!(substrRight(as.character(cnty.mal$rptfips), 3)%in%(c("999", "000")))),]
```

This looks at describing trends in NCANDS data at the county and state levels
# Proportions of cases that are substantiated by place
## States
```{r echo=FALSE, message=FALSE, cache=TRUE}

### plot total - victims (unsubstantiated) by state
ggplot(data=state.mal,
       aes(x=year, y=victims/tot.rpt))+
  geom_point()+
  facet_wrap(~staterr)+
  ggtitle("Proportion of investigated reports with confirmed victim")

with(state.mal, hist(victims/tot.rpt))
```

A problem: for 2006 - ND, OR report 0 non victims - not possible

## Counties
```{r echo=FALSE, message=FALSE, cache=TRUE}

### plot total - victims (unsubstantiated) by county
cnty.test<-cnty.mal[which(cnty.mal$rptfips%in%sample(unique(cnty.mal$rptfips),56)),]
ggplot(data=cnty.test,
       aes(x=year, y=victims/tot.rpt))+
  geom_point()+
  facet_wrap(~rptfips)

with(cnty.mal, hist(victims/tot.rpt))  
```

This is a random sample of 56 counties from the full data (out of 709 reporting in NCANDS b/w 2000 and 2006) looking at the proportion of cases with a confirmed victim for the TS plot, and all the counties for the histogram. 

