rm(list=ls())

.libPaths( c( .libPaths(), "U:/R") )

library(readr)
library(dplyr)
library(lme4)
library(texreg)
library(tidyr)
library(data.table)
library(ggplot2)
set.seed(1)

setwd("R:/Project/NCANDS/ncands-csv/")

dat<-fread("child-2012.csv")

### EDA FOR COUNTY MISSINGNESS
### create counts by rptsrc, count proportions in each cat
cdat<-full_join(
  dat%>%group_by(StaTerr, RptFIPS)%>%
    count(RptSrc),
  dat%>%group_by(StaTerr, RptFIPS)%>%
    summarise(cases=n(), 
              missing.NA=(sum(RptSrc=="unknown or missing")+sum(RptSrc==""))))
  
cdat<-cdat%>%mutate(proportion=n/cases)  

###Check counties where upper (observed + missing) more than 5 percent larger than observed
pol.check<-cdat%>%mutate(upper=n+missing.NA)%>%
  filter(RptSrc=="legal, law enforcement, or criminal justice")%>%
  filter(upper/n<1.05)
###Number of counties where upper bound is more than 5 percent larger than lower bound
n.large.error<-length(unique(dat$RptFIPS))-length(unique(pol.check$RptFIPS))

### Drop counties with more than 5 percent of cases missing
mdat<-cdat%>%filter(missing.NA/cases<0.05)
n.large.error2<-length(unique(dat$RptFIPS))-length(unique(mdat$RptFIPS))




## state proportion cop report plot

sdat<-dat%>%group_by(StaTerr)%>%summarise(pol=sum(RptSrc=="legal, law enforcement, or criminal justice"), n=n())
state<-read.csv("R:/Project/NCANDS/ncands-fc/statedat.csv")
state<-state%>%filter(year==2011)%>%select(state, childpov, child)
fips<-read.csv("R:/Project/NCANDS/ncands-fc/fips-key.csv")
state<-left_join(state, fips, by=c("state"))
s.plot<-left_join(sdat, state, by="StaTerr")
s.plot$pol.pc<-s.plot$pol/s.plot$child
s.plot$pol.cp<-s.plot$pol/s.plot$childpov
s.plot$pol.prop<-s.plot$pol/s.plot$n
s.plot<-s.plot%>%filter(!(StaTerr%in%c("PR", "PA", "MD", "DC", "XX")))
s.plot<-s.plot%>%mutate(StaTerr=factor(StaTerr),StaTerr=factor(StaTerr, levels=rev(levels(StaTerr))))

s.bar<-ggplot(s.plot, aes(x=(StaTerr),
                          y=pol.pc))+
  geom_bar(stat="identity")+coord_flip()+
  xlab("State")+ylab("Police reports of maltreatment per capita")

ggsave(s.bar, file="R:/Project/NCANDS/ncands-fc/state-police-bar.pdf", width=5, height=7)



year<-c(2012)

cnty.out<-NULL
st.out<-NULL

### getting false zeroes for rptvictim for 2000-2002 in some states, probably due to weird values on rptdisp

for(i in (1:length(year))){
  dat<-fread(files[i], colClasses="character", na.strings="")
  names(dat)<-tolower(names(dat))
  if("isvictim"%in%names(dat)){
    names(dat)[which(names(dat)=="isvictim")]<-"rptvictim"
  }
  if(!("rptvictim"%in%names(dat))){
    dat$rptvictim<-as.character(as.numeric(with(dat,(rptdisp=="1"|rptdisp=="2"|rptdisp=="3"))))
  }
  dat$rptsrc[which(dat$rptsrc=="0")]<-NA
  dat$rptsrc[which(is.na(dat$rptsrc))]<-"N.A"

### State counts
st.rpt<-dat%>%
  group_by(staterr)%>%
  count(rptsrc, staterr)%>%
  spread(rptsrc,n)
st.rpt[is.na(st.rpt)]<-0
names(st.rpt)[2:ncol(st.rpt)]<-paste("src", names(st.rpt)[2:ncol(st.rpt)], sep="")

st.rpt<-st.rpt%>%
  mutate(prof.rpt=src1+src2+src3+src4+src5+src6+src7)%>%
  mutate(inf.rpt=src8+src9+src10+src11+src12)

temp<-left_join(st.rpt,
                dat%>%
                  group_by(staterr)%>%
                  summarise(tot.rpt=n(),
                            unique.reports=n_distinct(rptid),
                            victims=sum(rptvictim=="1"))%>%
                  mutate(non.victim=tot.rpt-victims)%>%
                  mutate(year=year[i]), by="staterr")

temp<-as.data.frame(temp)
st.out<-bind_rows(st.out, temp)
  
### measurement and matching problems for year < 2006 when variable definition changes - 
### will need to match on state + rptcnty for 2000-2005 if I want to use those.  
### have to preserve fips as character to keep leading zeroes, for earlier years, no rptfips variable, 
### rptcnty as three digit county code (w/0 2 digit state, incl -1)
  
  if(year[i]>2005){ ### compute county counts for years 2006 and greater
    cnty.rpt<-dat%>%
      group_by(rptfips)%>%
      count(rptsrc, rptfips)%>%
      spread(rptsrc,n)
    cnty.rpt[is.na(cnty.rpt)]<-0
    names(cnty.rpt)[2:ncol(cnty.rpt)]<-paste("src", names(cnty.rpt)[2:ncol(cnty.rpt)], sep="")
    
    cnty.rpt<-cnty.rpt%>%
      mutate(prof.rpt=src1+src2+src3+src4+src5+src6+src7)%>%
      mutate(inf.rpt=src8+src9+src10+src11+src12)
    
    temp<-left_join(cnty.rpt,
              dat%>%
                group_by(rptfips, staterr)%>%
                summarise(tot.rpt=n(),
                          unique.reports=n_distinct(rptid),
                          victims=sum(rptvictim=="1"))%>%
                          mutate(non.victim=tot.rpt-victims)%>%
                          mutate(year=year[i]), by="rptfips")
  
    temp<-as.data.frame(temp)
    cnty.out<-bind_rows(cnty.out, temp)
  }
rm(dat)
}

write.csv(cnty.out,"cntyrpt06-12.csv", row.names=FALSE)
write.csv(st.out, "strpt00-12.csv", row.names=FALSE)
