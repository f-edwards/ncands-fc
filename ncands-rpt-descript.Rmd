```{r echo=FALSE, message=FALSE, cache=TRUE}
rm(list=ls())
library(readr)
library(dplyr)
library(tidyr)
library(nlme)
library(lme4)
library(ggplot2)
library(Amelia)
library(arm)
library(pander)
set.seed(1)

setwd("H:/")

substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

### PULLED COL WIDTH, COL NAMES FROM VariableLayout.xlsx, transposed
### READ AND CLEAN DATA
state.mal<-read.csv("H:/data/strpt00-12.csv", stringsAsFactors = FALSE)
### remove XX (death cases) and PR - can add death cases back in with state file (probably should!)
state.mal<-state.mal[-which(state.mal$staterr%in%c("XX", "PR")),]

cnty.mal<-read.csv("H:/data/cntyrpt06-12.csv", stringsAsFactors = FALSE)
### Strip out missing and de-identified counties
cnty.mal<-cnty.mal[-which(cnty.mal$rptfips==0),]
cnty.mal<-cnty.mal[which(!(substrRight(as.character(cnty.mal$rptfips), 3)%in%(c("999", "000")))),]

```

This looks at describing trends in NCANDS data at the county and state levels
# Proportions of cases that are substantiated by place
## States
```{r echo=FALSE, message=FALSE, cache=TRUE}

### plot total - victims (unsubstantiated) by state
ggplot(data=state.mal,
       aes(x=year, y=victims/tot.rpt))+
  geom_point()+
  facet_wrap(~staterr)+
  ggtitle("Proportion of investigated reports with confirmed victim")

with(state.mal, hist(victims/tot.rpt))
```

A problem: for 2006 - ND, OR report 0 non victims - not possible

## Counties
```{r echo=FALSE, message=FALSE, cache=TRUE}

### plot total - victims (unsubstantiated) by county
cnty.test<-cnty.mal[which(cnty.mal$rptfips%in%sample(unique(cnty.mal$rptfips),56)),]
ggplot(data=cnty.test,
       aes(x=year, y=victims/tot.rpt))+
  geom_point()+
  facet_wrap(~rptfips)

with(cnty.mal, hist(victims/tot.rpt))  
```

This is a random sample of 56 counties from the full data (out of 709 reporting in NCANDS b/w 2000 and 2006) looking at the proportion of cases with a confirmed victim for the TS plot, and all the counties for the histogram. 

# Proportion of reports by reporter type
## States
```{r echo=FALSE, message=FALSE, cache=TRUE}
ggplot(data=state.mal,
       aes(x=year, y=src1/tot.rpt))+
  geom_line()+
  geom_line(x=year, y=src2/tot.rpt, color="blue")+
  geom_line(x=year, y=src3/tot.rpt, color="red")+
  geom_line(x=year, y=src4/tot.rpt, color="green")+
  facet_wrap(~staterr)+
  ggtitle("socserv:black, med:blue, ment hlth: red, law enf:green")

ggplot(data=state.mal,
       aes(x=year, y=src5/tot.rpt))+
  geom_line()+
  geom_line(x=year, y=src6/tot.rpt, color="blue")+
  geom_line(x=year, y=src7/tot.rpt, color="red")+
  geom_line(x=year, y=src8/tot.rpt, color="green")+
  facet_wrap(~staterr)+
  ggtitle("edu:black, day care:blue, foster cr: red, victim:green")

ggplot(data=state.mal,
       aes(x=year, y=src9/tot.rpt))+
  geom_line()+
  geom_line(x=year, y=src10/tot.rpt, color="blue")+
  geom_line(x=year, y=src11/tot.rpt, color="red")+
  geom_line(x=year, y=src12/tot.rpt, color="green")+
  facet_wrap(~staterr)+
  ggtitle("parent:black, relative:blue, nghbr: red, perp:green")

ggplot(data=state.mal,
       aes(x=year, y=src13/tot.rpt))+
  geom_line()+
  geom_line(x=year, y=src88/tot.rpt, color="blue")+
  geom_line(x=year, y=src99/tot.rpt, color="red")+
  geom_line(x=year, y=srcN.A/tot.rpt, color="green")+
  facet_wrap(~staterr)+
  ggtitle("anon:black, other:blue, unk: red, NA:green")

hist(state.mal$prof.rpt)
hist(cnty.mal$inf.rpt)

var(state.mal$prof.rpt)

```
Describe what's going on here

## Counties
```{r echo=FALSE, message=FALSE, cache=TRUE}
ggplot(data=cnty.test,
       aes(x=year, y=src1/tot.rpt))+
  geom_line()+
  geom_line(x=year, y=src2/tot.rpt, color="blue")+
  geom_line(x=year, y=src3/tot.rpt, color="red")+
  geom_line(x=year, y=src4/tot.rpt, color="green")+
  facet_wrap(~staterr)+
  ggtitle("socserv:black, med:blue, ment hlth: red, law enf:green")

ggplot(data=cnty.test,
       aes(x=year, y=src5/tot.rpt))+
  geom_line()+
  geom_line(x=year, y=src6/tot.rpt, color="blue")+
  geom_line(x=year, y=src7/tot.rpt, color="red")+
  geom_line(x=year, y=src8/tot.rpt, color="green")+
  facet_wrap(~staterr)+
  ggtitle("edu:black, day care:blue, foster cr: red, victim:green")

ggplot(data=cnty.test,
       aes(x=year, y=src9/tot.rpt))+
  geom_line()+
  geom_line(x=year, y=src10/tot.rpt, color="blue")+
  geom_line(x=year, y=src11/tot.rpt, color="red")+
  geom_line(x=year, y=src12/tot.rpt, color="green")+
  facet_wrap(~staterr)+
  ggtitle("parent:black, relative:blue, nghbr: red, perp:green")

ggplot(data=cnty.test,
       aes(x=year, y=src13/tot.rpt))+
  geom_line()+
  geom_line(x=year, y=src88/tot.rpt, color="blue")+
  geom_line(x=year, y=src99/tot.rpt, color="red")+
  geom_line(x=year, y=srcN.A/tot.rpt, color="green")+
  facet_wrap(~staterr)+
  ggtitle("anon:black, other:blue, unk: red, NA:green")

hist(cnty.mal$prof.rpt)
hist(cnty.mal$inf.rpt)

var(cnty.mal$prof.rpt)

```

Describe what's going on here

# Moving on to multivariate
First, check out NCANDS state files for neccessary appends (can't find the damn files...  they were pretty useless anyway, could check the old laptop / writing center pc)
Bring in CDC county pop 
Merge state data
For counties - explore multilevel (year|state)+(1|county)

