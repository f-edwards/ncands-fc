```{r echo=FALSE, message=FALSE, cache=TRUE}
rm(list=ls())
library(readr)
library(dplyr)
library(tidyr)
library(nlme)
library(lme4)
library(ggplot2)
library(Amelia)
library(arm)
library(pander)
set.seed(1)

setwd("H:/")

substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

### PULLED COL WIDTH, COL NAMES FROM VariableLayout.xlsx, transposed
### READ AND CLEAN DATA
state.mal<-read.csv("H:/data/strpt00-12.csv", stringsAsFactors = FALSE)
state.dat<-read.csv("H:/data/statedat.csv", stringsAsFactors=FALSE)
names(state.dat)[which(names(state.dat)=="stname")]<-"staterr"
state.mal<-left_join(state.mal, state.dat, by=c("staterr", "year"))
### remove XX (death cases) and PR - can add death cases back in with state file (probably should!)
state.mal<-state.mal[-which(state.mal$staterr%in%c("XX", "PR")),]

cnty.mal<-read.csv("H:/data/cntyrpt06-12.csv", stringsAsFactors = FALSE)
### Strip out missing and de-identified counties
cnty.mal<-cnty.mal[-which(cnty.mal$rptfips==0),]
cnty.mal<-cnty.mal[which(!(substrRight(as.character(cnty.mal$rptfips), 3)%in%(c("999", "000")))),]

pop<-read.table("H:/data/CDC-Wonder-County-Kids.tsv", sep="",
                stringsAsFactors = FALSE, head=TRUE)
names(pop)<-c("cname", "FIPS", "year", "year.dup", "child.pop")
### pull out state abrev from "NAME County, ST format in var
z<-do.call("rbind",(strsplit(pop$cname, ", ")))
pop$cname<-z[,1]
pop$state<-z[,2]

names(cnty.mal)[which(names(cnty.mal)=="staterr")]<-"state"
names(cnty.mal)[which(names(cnty.mal)=="rptfips")]<-"FIPS"
cnty.mal<-cnty.mal[-which(cnty.mal$state=="PR"),]
### MIAMI DADE CHANGED FROM 12025 to 12086
cnty.mal[which(cnty.mal$FIPS==12025), "FIPS"]<-12086

rpt.cnty<-left_join(cnty.mal, pop, by=c("FIPS", "year", "state"))


```

This describes trends in focal NCANDS outcomes at the county and state levels.  It explores substantiation of investigations (RptVictim) and the source of maltreatment reports (RptSrc) at the place level.
# Total cases by place

Looks like no effect of recession on maltreatment reports - that's odd.  

```{r echo=FALSE, message=FALSE, cache=TRUE, warning=FALSE}

ggplot(data=state.mal,
       aes(x=year, y=tot.rpt/child))+
  geom_point()+
  facet_wrap(~staterr)+
  scale_x_continuous(breaks=c(2004,2010))+
  ggtitle("Total Reports")
```

# Substantiated cases by place
```{r echo=FALSE, message=FALSE, cache=TRUE, warning=FALSE}

ggplot(data=state.mal,
       aes(x=year, y=victims/child))+
  geom_point()+
  facet_wrap(~staterr)+
  scale_x_continuous(breaks=c(2004,2010))+
  ggtitle("Substantiated cases")

require(maps)

names(state.mal)[which(names(state.mal)=="statename")]<-"region"
state.mal$region<-tolower(state.mal$region)
state.11<-state.mal[state.mal$year==2011,]
states<-map_data("state")
choro<-merge(states, state.11, by="region")
choro <- choro[order(choro$order), ]

MapPlot <- ggplot(choro,
 aes(x = long, y = lat, group = group, fill =(tot.rpt/child)))
MapPlot <- MapPlot + geom_polygon(aes(fill = (tot.rpt/child)), colour = "gray20", size = 0.1) 

MapPlot <- MapPlot + coord_map(project="albers", at0 = 45.5, lat1 = 29.5)  

MapPlot <- MapPlot +  theme(panel.grid.minor=element_blank(), panel.grid.major=element_blank(),
		panel.border = element_blank(), panel.background=element_blank())+
	scale_y_continuous(name="", breaks=NULL)+
	scale_x_continuous(name="", breaks=NULL)

MapPlot<- MapPlot + theme(strip.background=element_blank(), 
	strip.text.x=element_text(size=10),
	strip.text.y=element_blank())

MapPlot <- MapPlot + xlab(NULL) + ylab(NULL)
MapPlot

MapPlot <- ggplot(choro,
 aes(x = long, y = lat, group = group, fill =(victims/child)))
MapPlot <- MapPlot + geom_polygon(aes(fill = (victims/child)), colour = "gray20", size = 0.1) 

MapPlot <- MapPlot + coord_map(project="albers", at0 = 45.5, lat1 = 29.5)  

MapPlot <- MapPlot +  theme(panel.grid.minor=element_blank(), panel.grid.major=element_blank(),
		panel.border = element_blank(), panel.background=element_blank())+
	scale_y_continuous(name="", breaks=NULL)+
	scale_x_continuous(name="", breaks=NULL)

MapPlot<- MapPlot + theme(strip.background=element_blank(), 
	strip.text.x=element_text(size=10),
	strip.text.y=element_blank())

MapPlot <- MapPlot + xlab(NULL) + ylab(NULL)
MapPlot

```

# Proportions of cases that are substantiated by place
## States
```{r echo=FALSE, message=FALSE, cache=TRUE, warning=FALSE}

### plot total - victims (unsubstantiated) by state
ggplot(data=state.mal,
       aes(x=year, y=victims/tot.rpt))+
  geom_point()+
  facet_wrap(~staterr)+
  scale_x_continuous(breaks=c(2004,2010))+
  ggtitle("Proportion of investigated reports with confirmed victim")
```

This plot shows the proportion of cases that were found to have a victim of maltreatment by state and year.  The average substantiation rate for this period was `r mean(state.mal$victims/state.mal$tot.rpt)` with an SD of `r sd(state.mal$victims/state.mal$tot.rpt)`.  The time series plots show considerable variation both between and within states in substantiation rates.  

There are some obvious data quality issues - Kansas in 2001, North Dakota in 2006, and Oregon in 2006 report only substantiated cases.  These observations should probably be treated as missing and imputed.  

```{r echo=FALSE, message=FALSE, cache=TRUE}
with(state.mal, hist(victims/tot.rpt, main="Substantiation rates, States 2000-2012"))
```

This histogram gives a better overview of the distribution of the data, and shows substantial heterogeneity between states in their rate of report substantiation.

## Counties
For all time series plots, I draw a random sample of 56 counties from the over 700 in the data.  Labels are FIPS codes.
```{r echo=FALSE, message=FALSE, cache=TRUE}

### plot total - victims (unsubstantiated) by county
cnty.test<-cnty.mal[which(cnty.mal$rptfips%in%sample(unique(cnty.mal$rptfips),56)),]
ggplot(data=cnty.test,
       aes(x=year, y=victims/tot.rpt))+
  geom_point()+
  facet_wrap(~rptfips)+
  scale_x_continuous(breaks=c(2006,2010))+
  ggtitle("Substantiation rates, Counties 2006-2012")
```

The distributions for states and counties look pretty similar, with similar problems of uniform substantiation in a few counties (those within the problematic states here - should these observations uniformly be imputed?)

```{r echo=FALSE, message=FALSE, cache=TRUE}
with(cnty.mal, hist(victims/tot.rpt, main="Substantiation rates, Counties 2006-2012"))  
```

This distribution (for large counties) looks nearly identical to the overall state distribution, suggesting that a) most cases come from large counties (`r sum(cnty.mal$tot.rpt)/sum(state.mal[state.mal$year>2005,"tot.rpt"])`) from counties between 2006-2012, with additional analysis needed to distinguish whether the distribution of cases from rural counties show different substantiation patterns.

# Proportion of reports by reporter type
## States
I break down the variable RptSrc into counts of each value by state and county.  RptSrc takes the values, which I categorize into professional sources:

- Social service provider
- Medical provider
- Mental health provider
- Law enforcement or court personnel
- Education personnel
- Day care personnel
- Substitute care provider (foster care)

non-professional sources:

- Self (victim)
- Parent
- Other relative
- Neighbor/friend
- Alleged perpetrator

and various categories of missing:

- Anonymous
- Other
- Unknown (coded)
- Missing from data 

To check the distributions of the values of this variable across units and look for data quality issues, I plot time series for each count by state. 

```{r echo=FALSE, message=FALSE, cache=TRUE}
ggplot(data=state.mal,
       aes(x=year))+
  geom_line(aes(y=(src1/tot.rpt)))+
  geom_line(aes(y=(src2/tot.rpt)), colour="blue")+
  geom_line(aes(y=src3/tot.rpt), color="red")+
  geom_line(aes(y=src4/tot.rpt), color="green4")+
  facet_wrap(~staterr)+
  scale_x_continuous(breaks=c(2004,2010))+
  scale_y_continuous(limits=c(0, 0.4))+
  ggtitle("socserv:black, med:blue, ment hlth: red, law enf:green")
```

This TS plot shows state-level reporting rates for a subset of professional mandated reporters.  For most states, police (green) are contributing most reports from this group, mean, sd: `r with(state.mal, paste(mean(src4/tot.rpt), sd(src4/tot.rpt)))`.  There are some weird within-state fluctuations that may be artifacts of data collection (i.e. NC, TN), and zeroes in AK indicated nonreporting of this measure for this time period.  Is this a problem for modeling?  Overall, it doesn't look too bad.

```{r echo=FALSE, message=FALSE, cache=TRUE}

ggplot(data=state.mal,
       aes(x=year))+
  geom_line(aes(y=src5/tot.rpt))+
  geom_line(aes(y=src6/tot.rpt), colour="blue")+
  geom_line(aes(y=src7/tot.rpt), colour="red")+
  geom_line(aes(y=src8/tot.rpt), colour="green4")+
  facet_wrap(~staterr)+
  scale_x_continuous(breaks=c(2004,2010))+
  ggtitle("edu:black, day care:blue, foster cr: red, victim:green")
```

This plot includes three more professional reports as well as victims - education personnel nationally produce a large volume of total reports, mean,sd: `r with(state.mal, paste(mean(src5/tot.rpt), sd(src5/tot.rpt)))`

```{r echo=FALSE, message=FALSE, cache=TRUE, warning=FALSE}
ggplot(data=state.mal,
       aes(x=year))+
  geom_line(aes(y=src9/tot.rpt))+
  geom_line(aes(y=src10/tot.rpt), color="blue")+
  geom_line(aes(y=src11/tot.rpt), color="red")+
  geom_line(aes(y=src12/tot.rpt), color="green")+
  facet_wrap(~staterr)+
  scale_x_continuous(breaks=c(2004,2010))+
  ggtitle("parent:black, relative:blue, nghbr: red, perp:green")
```

The major categories of informal reports - none are greater than 20 percent, and the same data quality issues are consistent by state - clearly a reporting artifact.
```{r echo=FALSE, message=FALSE, cache=TRUE}
ggplot(data=state.mal,
       aes(x=year))+
  geom_line(aes(y=src13/tot.rpt))+
  geom_line(aes(y=src88/tot.rpt), color="blue")+
  geom_line(aes(y=src99/tot.rpt), color="red")+
  geom_line(aes(y=srcN.A/tot.rpt), color="green")+
  facet_wrap(~staterr)+
  scale_x_continuous(breaks=c(2004,2010))+
  scale_y_continuous(limits=c(0, 0.4))+
  ggtitle("anon:black, other:blue, unk: red, NA:green")
```

This breaks out the categories of reported and unreported missingness in the data.  I don't think they should be treated equivalently.  Anonymous and other codes are clearly positive reports from states and probably should be left as-is, or perhaps lumped into informal reports(?).  Coded missingness (99 in the data) and complete missigness (uncoded in the data) are likely subject to different processes, but documentation isn't helpful here.  Additionally, imputation of missing data at the individual level, if appropriate, would be a headache (N > 30 mil) - is some other strategy for full or partial missingness at a higher level of aggregation appropriate?

```{r echo=FALSE, message=FALSE, cache=TRUE}
hist(state.mal$prof.rpt/state.mal$tot.rpt)
hist(state.mal$inf.rpt/state.mal$tot.rpt)
```

Reports by professionals make up `r mean(state.mal$prof.rpt/state.mal$tot.rpt)`, SD `r sd(state.mal$prof.rpt/state.mal$tot.rpt)`.  Looking at the time series plots and histograms, there is large variation between states in the sources of reports, even after dropping erroneous zero reports.


## Counties
```{r echo=FALSE, message=FALSE, cache=TRUE}
hist(cnty.mal$prof.rpt/cnty.mal$tot.rpt)
hist(cnty.mal$inf.rpt/cnty.mal$tot.rpt)
```

For the large counties that are not de-identified in the data, an average proportion of formal reports is `r mean(cnty.mal$prof.rpt/cnty.mal$tot.rpt)`, SD `r sd(cnty.mal$prof.rpt/cnty.mal$tot.rpt)`, which is similar to the figures for states (unsurprising given that these counties make up more than 80 percent of state counts).

# Moving on to multivariate
First, check out NCANDS state files for neccessary appends (can't find the damn files...  they were pretty useless anyway, could check the old laptop / writing center pc)
Bring in CDC county pop 
Merge state data
For counties - explore multilevel (year|state)+(1|county)

```{r echo=FALSE, message=FALSE, cache=TRUE}
### add overdispersion
rpt.cnty$obs_n<-(1:nrow(rpt.cnty))
m.0<-glmer(tot.rpt~I(year-2006)+(I(year-2006)|FIPS)+(I(year-2006)|state)+(1|obs_n), data=rpt.cnty, family=poisson, offset=log(child.pop))

### write function to read in NHGIS pop data
read.nhgis<-function(x){
  temp<-read.csv(x)
  ### Have to pasted together state and county codes
  ### need county codes to be XXX
  temp$county<-formatC(temp$COUNTYA, width = 3, format = "d", flag = "0")
  ### Convert to 01001 SSCCC FIPS FORMAT
  temp$FIPS<-paste(as.character(temp$STATEA), temp$county, sep="")
  ### Construct needed vars
  ### % of family households getting SSI, pub assist, SNAP in past 12 mos
  temp$fam.assist<-(temp$UTAE003/temp$UTAE001)
  temp$ch.pov<-with(temp,(UV9E004+UV9E005+UV9E006+UV9E007+UV9E008+UV9E009)+
                      (UV9E018+UV9E019+UV9E020+UV9E021+UV9E022+UV9E023))
  ### Wonky stuff going on when applying margin of error - results in negative pop counts... ignoring for now
  ### i.e. hist((temp$UTAM003+temp$UTAE003)/temp$UTAE003)
  out<-data.frame("FIPS"=as.numeric(temp$FIPS), "fam.assist"=temp$fam.assist, "ch.pov"=temp$ch.pov)
  return(out)
}
read.nhgis2<-function(x){
  temp<-read.csv(x)
  ### Have to pasted together state and county codes
  ### need county codes to be XXX
  temp$county<-formatC(temp$COUNTYA, width = 3, format = "d", flag = "0")
  ### Convert to 01001 SSCCC FIPS FORMAT
  temp$FIPS<-paste(as.character(temp$STATEA), temp$county, sep="")
  ### Construct needed vars
  ### % of family households getting SSI, pub assist, SNAP in past 12 mos
  temp$c.pop<-temp$UEYE001
  temp$c.wht.pop<-temp$UEYE003
  temp$c.blk.pop<-temp$UEYE004+temp$UEYE014
  temp$c.amind.pop<-temp$UEYE005+temp$UEYE015
  temp$c.hisp.pop<-temp$UEYE012
  
  out<-data.frame("FIPS"=as.numeric(temp$FIPS), "c.pop"=temp$c.pop, "c.wht.pop"=temp$c.wht.pop, "c.blk.pop"=temp$c.blk.pop, "c.amind.pop"=temp$c.amind.pop,
                  "c.hisp.pop"=temp$c.hisp.pop)
  return(out)
}
cnty.pov1<-read.nhgis("h:/data/nhgis0016_ds202_20135_2013_county.csv")
cnty.race<-read.nhgis2("h:/data/nhgis0017_ds201_20135_2013_county.csv")
cnty.pov<-left_join(cnty.pov1, cnty.race, by="FIPS")

## read ed data
cnty.ed<-read.csv("H:/data/NCES_Report_215.csv", skip=10)
cnty.ed<-cnty.ed[-(3153:nrow(cnty.ed)),]
names(cnty.ed)<-c("state", "cname", "FIPS", "tot.schools", "charter.schools",
                  "state.fips", "tot.students", "free.lunch", "red.lunch",
                  "free.red.lunch", "ell", "indiv.ed.prog.stud", "tot.staff",
                  "s.t.ratio", "fte.teachers.scl", "fte.teachers.dist", "instruct.aides",
                  "instruct.coord", "elem.counsel", "elem.teachers", "k.teachers",
                  "lea.admin", "lea.admin.support", "libr", "other.support",
                  "pre.k.teachers", "school.admin", "school.admin.support",
                  "sec.counsel", "sec.teachers", "student.support.dist", "counselors",
                  "ungraded.teachers", "other.counselors")


### use single year for now - most data in 2011
cnty.11<-left_join(rpt.cnty[rpt.cnty$year==2011,], cnty.pov, by="FIPS")
cnty.11$ch.pov.rt<-cnty.11$ch.pov/cnty.11$child.pop
mc.0<-glmer(tot.rpt~ch.pov.rt+(1|state)+(1|obs_n), data=cnty.11, family=poisson, offset=log(child.pop))
### cor(fam.assist, ch.pov.rt)>0.9, can't have both in model
### bring in state covars
state.11<-state.mal[state.mal$year==2011,]
cnty.11$staterr<-cnty.11$state
cnty.dat<-left_join(cnty.11, state.11, by=c("staterr"))

mt1<-tot.rpt.x~scale(ch.pov.rt)+scale(inc.crime)+scale(ideo)+confed+scale(pctblk)+
             scale(I(c.blk.pop/c.pop))+scale(I(c.amind.pop/c.pop))+scale(I(c.hisp.pop/c.pop))+
              (1|staterr)+(1|obs_n.x)

mp1<-prof.rpt.x~scale(ch.pov.rt)+scale(inc.crime)+scale(ideo)+confed+scale(pctblk)+
             scale(I(c.blk.pop/c.pop))+scale(I(c.amind.pop/c.pop))+scale(I(c.hisp.pop/c.pop))+
              (1|staterr)+(1|obs_n.x)


mi1<-inf.rpt.x~scale(ch.pov.rt)+scale(inc.crime)+scale(ideo)+confed+scale(pctblk)+
             scale(I(c.blk.pop/c.pop))+scale(I(c.amind.pop/c.pop))+scale(I(c.hisp.pop/c.pop))+
              (1|staterr)+(1|obs_n.x)

mp2<-prof.rpt.x~scale(ch.pov.rt)+scale(inc.crime)+scale(ideo)+confed+
            scale(c.wht.pop/c.pop)+
              (1|staterr)+(1|obs_n.x)

mv1<-victims.x~scale(ch.pov.rt)+scale(inc.crime)+scale(ideo)+confed+scale(pctblk)+
             scale(I(c.blk.pop/c.pop))+scale(I(c.amind.pop/c.pop))+scale(I(c.hisp.pop/c.pop))+
              (1|staterr)+(1|obs_n.x)

p.1<-glmer(mp1, data=cnty.dat, family=poisson, offset=log(child.pop))
p.2<-glmer(mp2, data=cnty.dat, family=poisson, offset=log(child.pop))
i.1<-glmer(mi1, data=cnty.dat, family=poisson, offset=log(child.pop))
t.1<-glmer(mt1, data=cnty.dat, family=poisson, offset=log(child.pop))
v.1<-glmer(mv1, data=cnty.dat, family=poisson, offset=log(child.pop))


### different outcome, substantiation rate
sub.1<-lmer(scale(I(victims.x/tot.rpt.x))~scale(ch.pov.rt)+scale(inc.crime)+scale(ideo)+confed+
             scale(I(c.blk.pop/c.pop))+scale(I(c.amind.pop/c.pop))+scale(I(c.hisp.pop/c.pop))+
              (1|staterr), data=cnty.dat)




```

